#/bin/bash


echo Start $(date)

echo Creating directories
sudo mkdir /media/external/backups
sudo mkdir /media/external/backups/docker
# sudo rm /media/external/backups/docker/*

today="$(date +%u)"

if [ -n "$(docker ps -f "name=pihole" -f "status=running" -q)" ]; then
	echo Runing PiHole Teleport
	docker exec pihole pihole -a -t /etc/pihole/teleport.tar.gz
	sudo mv /var/lib/docker-data/volumes/pihole-stack_pihole/_data/teleport.tar.gz /media/external/backups/teleport.tar.gz
else
	echo Skipping Pi-Hole steps. Pi-Hole is not running!!
fi

echo Backing up Docker Containers

for containername in $(docker ps --format "{{.Names}}" -a); do
	echo Backing up container $containername
	sudo docker export $containername | gzip >/tmp/container-$containernane.tar.gz
	sudo mv -f /tmp/container-$containernane.tar.gz /media/external/backups/docker/container-$containername.tar.gz
done

echo Backing up Docker Volumes

for volumename in $(docker volume ls -q); do
	echo Backing up volume $volumename

	sudo rm /media/external/backups/docker/volume-$volumename.tar.gz

	sudo docker run --rm \
		--mount source=$volumename,target=/$volumename \
		-v /media/external/backups/docker:/backup \
		busybox \
		tar -czvf /backup/volume-$volumename.tar.gz $volumename

done

echo Backing up Home Directories
sudo tar -zcf /media/external/backups/docker.tgz /home/jcrocker/src/all-things-docker
sudo tar -zcf /media/external/backups/docker-private.tgz /home/jcrocker/docker-private
sudo tar -zcf /media/external/backups/scripts.tgz /home/jcrocker/src/all-things-linux-bash

echo Finish $(date)
